services:
  miner:
    image: ghcr.io/backend-developers-ltd/infinitehash-subnet-prod@sha256:6dab0713c45901f589ba531567d84555a12a53aaf79d277639997e19916475ae
    pull_policy: always
    init: true
    restart: unless-stopped
    working_dir: /root/src
    command: python -m infinite_hashes.aps_miner /root/src/config.toml
    environment:
      - PYTHONUNBUFFERED=1
      - APS_MINER_PROXY_MODE=ihp
      - APS_MINER_POOLS_CONFIG_PATH=/root/src/proxy/pools.toml
      - APS_MINER_SUBNET_POOL_NAME=${APS_MINER_SUBNET_POOL_NAME:-central-proxy}
      - APS_MINER_IHP_RELOAD_SENTINEL=/root/src/proxy/.reload-ihp
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./config.toml:/root/src/config.toml:ro
      - ~/.bittensor:/root/.bittensor
      - ./logs:/root/src/logs
      - ./proxy:/root/src/proxy
    depends_on:
      ihp-postgres:
        condition: service_healthy
      ihp-proxy:
        condition: service_started
    logging: &logging
      driver: journald
      options:
        tag: '{{.Name}}'

  ihp-postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_USER=ihp
      - POSTGRES_PASSWORD=ihp
      - POSTGRES_DB=ihp
    volumes:
      - ihp-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ihp -d ihp"]
      interval: 5s
      timeout: 5s
      retries: 5
    logging:
      <<: *logging

  ihp-proxy:
    image: backenddevelopersltd/infinitehash-proxy-server:v1-latest
    restart: unless-stopped
    stop_grace_period: 15s
    env_file:
      - ./proxy/.env
    ports:
      - "3333:3333"
      - "9090:9090"
    volumes:
      - ./proxy/pools.toml:/etc/infinite-hash-proxy/pools.toml:ro
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    depends_on:
      ihp-postgres:
        condition: service_healthy
    logging:
      <<: *logging

  ihp-api:
    image: backenddevelopersltd/infinitehash-proxy-api:v1-latest
    restart: unless-stopped
    env_file:
      - ./proxy/.env
    ports:
      - "8000:8000"
    depends_on:
      ihp-postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "-O", "/dev/null", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      <<: *logging

  ihp-proxy-reloader:
    image: alpine:3.20
    restart: unless-stopped
    pid: "service:ihp-proxy"
    command: >
      sh -c "while true; do
               if [ -f /config/.reload-ihp ]; then
                 echo \"$(date -u +\"%Y-%m-%dT%H:%M:%SZ\") IHP reloader: sending HUP to pid 1\";
                 rm -f /config/.reload-ihp;
                 kill -HUP 1 || true;
               fi;
               sleep ${IHP_RELOAD_INTERVAL:-5};
             done"
    volumes:
      - ./proxy:/config
    depends_on:
      ihp-proxy:
        condition: service_started
    logging:
      <<: *logging

volumes:
  ihp-postgres-data:
