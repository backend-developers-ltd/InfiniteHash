services:
  redis:
    image: mirror.gcr.io/valkey/valkey:8.1-alpine
    command: valkey-server --appendonly yes
    healthcheck:
      test: valkey-cli ping
    restart: unless-stopped
    volumes:
      - redis:/data
    logging: &logging
      driver: journald
      options:
        tag: '{{.Name}}'

  db:
    image: postgres:14.0-alpine
    healthcheck:
      test: pg_isready -U postgres || exit 1
    restart: unless-stopped
    ports:
      - "127.0.0.1:${POSTGRES_HOST_PORT:-8432}:5432"
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_RW_PASSWORD:-POSTGRES_PASSWORD_LOL}
      - POSTGRES_DB:postgres
    volumes:
      - db:/var/lib/postgresql/data
    logging:
      <<: *logging

  db-readonly-user:
    image: postgres:14.0-alpine
    depends_on:
      db:
        condition: service_healthy
    environment:
      - POSTGRES_HOST=db
      - POSTGRES_DB=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_RW_PASSWORD:-POSTGRES_PASSWORD_LOL}
      - POSTGRES_READONLY_USER=${POSTGRES_READONLY_USER:-}
      - POSTGRES_READONLY_PASSWORD=${POSTGRES_READONLY_PASSWORD:-}
      - POSTGRES_READONLY_MAX_RETRIES=${POSTGRES_READONLY_MAX_RETRIES:-30}
      - POSTGRES_READONLY_RETRY_INTERVAL=${POSTGRES_READONLY_RETRY_INTERVAL:-1}
    entrypoint:
      - /bin/sh
      - -c
      - |
        if [ -z "$${POSTGRES_READONLY_USER}" ] || [ -z "$${POSTGRES_READONLY_PASSWORD}" ]; then
          echo "[readonly-user] env not set, skipping"
          exec tail -f /dev/null
        fi
        export PGPASSWORD="$${POSTGRES_PASSWORD}"
        echo "[readonly-user] waiting for db on $${POSTGRES_HOST}/$${POSTGRES_DB}"
        i=0
        while ! pg_isready -h "$${POSTGRES_HOST}" -U "$${POSTGRES_USER}" -d "$${POSTGRES_DB}" >/dev/null 2>&1; do
          i=$$((i+1))
          if [ "$$i" -ge "$${POSTGRES_READONLY_MAX_RETRIES}" ]; then
            echo "[readonly-user] database never became ready"
            exit 1
          fi
          sleep "$${POSTGRES_READONLY_RETRY_INTERVAL}"
        done
        ro_user_esc=$$(printf '%s' "$${POSTGRES_READONLY_USER}" | sed "s/'/''/g")
        ro_pass_esc=$$(printf '%s' "$${POSTGRES_READONLY_PASSWORD}" | sed "s/'/''/g")
        ro_user_ident=$$(printf '%s' "$${POSTGRES_READONLY_USER}" | sed 's/\"/""/g')
        db_name_ident=$$(printf '%s' "$${POSTGRES_DB}" | sed 's/\"/""/g')
        PSQ="psql -v ON_ERROR_STOP=1 -h $${POSTGRES_HOST} -U $${POSTGRES_USER} -d $${POSTGRES_DB}"
        role_exists=$$($$PSQ -tAc "SELECT 1 FROM pg_roles WHERE rolname='$${ro_user_esc}' LIMIT 1")
        if [ -z "$$role_exists" ]; then
          $$PSQ -c "CREATE ROLE \"$$ro_user_ident\" WITH LOGIN PASSWORD '$${ro_pass_esc}'"
        else
          $$PSQ -c "ALTER ROLE \"$$ro_user_ident\" WITH LOGIN PASSWORD '$${ro_pass_esc}'"
        fi
        $$PSQ -c "GRANT CONNECT ON DATABASE \"$$db_name_ident\" TO \"$$ro_user_ident\""
        $$PSQ -c "GRANT USAGE ON SCHEMA public TO \"$$ro_user_ident\""
        $$PSQ -c "GRANT SELECT ON ALL TABLES IN SCHEMA public TO \"$$ro_user_ident\""
        $$PSQ -c "GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO \"$$ro_user_ident\""
        $$PSQ -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO \"$$ro_user_ident\""
        $$PSQ -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON SEQUENCES TO \"$$ro_user_ident\""
        echo "[readonly-user] ready"
        exec tail -f /dev/null
    restart: "no"
    logging:
      <<: *logging

  app:
    image: ghcr.io/backend-developers-ltd/infinitehash-subnet-prod@sha256:0cfbe7d33dd1cefc9486b259b11ed80553b72b5cf82b6aa2fc5354bb1c09336f
    pull_policy: always
    healthcheck:
      test: ["CMD", "./healthcheck.py", "/var/run/gunicorn/gunicorn.sock"]
    init: true
    restart: unless-stopped
    env_file: ./.env
    environment:
      - ENV=prod
      - DATABASE_URL=postgres://postgres:${POSTGRES_RW_PASSWORD:-POSTGRES_PASSWORD_LOL}@db:5432/postgres
      - REDIS_HOST=localhost
      - REDIS_PORT=8379
      # Add this variable to all containers that should dump Prometheus metrics.  Each container besides this one
      # should use a different subdirectory of /prometheus-multiproc-dir, e.g.
      # - PROMETHEUS_MULTIPROC_DIR=/prometheus-multiproc-dir/other-container
      # Don't forget to also mount the prometheus-metrics volume in other containers too.
      - PROMETHEUS_MULTIPROC_DIR=/prometheus-multiproc-dir
    volumes:
      - backend-static:/root/src/static
      - gunicorn-socket:/var/run/gunicorn
      - ./media:/root/src/media
      - ~/.bittensor:/root/.bittensor
      # Add this mount to each container that should dump Prometheus metrics.
      - ./prometheus-metrics:/prometheus-multiproc-dir
    depends_on:
      - redis
      - db
    logging:
      <<: *logging

  celery-worker:
    image: ghcr.io/backend-developers-ltd/infinitehash-subnet-prod@sha256:0cfbe7d33dd1cefc9486b259b11ed80553b72b5cf82b6aa2fc5354bb1c09336f
    pull_policy: always
    init: true
    healthcheck:
      test: celery -A infinite_hashes status > /dev/null || exit 1
    restart: unless-stopped
    env_file: ./.env
    environment:
      - ENV=prod
      - DEBUG=off
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_MASTER_CONCURRENCY=3
      - CELERY_WORKER_CONCURRENCY=3
      - DATABASE_URL=postgres://postgres:${POSTGRES_RW_PASSWORD:-POSTGRES_PASSWORD_LOL}@db:5432/postgres
      - REDIS_HOST=localhost
      - REDIS_PORT=8379
      - PROMETHEUS_MULTIPROC_DIR=/prometheus-multiproc-dir/celery-worker
    command: ./celery-entrypoint.sh
    volumes:
      - ~/.bittensor:/root/.bittensor
      - ./prometheus-metrics:/prometheus-multiproc-dir
    tmpfs: /run
    depends_on:
      - redis
      - db
    links:
      - redis
    logging:
      <<: *logging

  celery-beat:
    image: ghcr.io/backend-developers-ltd/infinitehash-subnet-prod@sha256:0cfbe7d33dd1cefc9486b259b11ed80553b72b5cf82b6aa2fc5354bb1c09336f
    pull_policy: always
    init: true
    restart: unless-stopped
    env_file: ./.env
    environment:
      - ENV=prod
      - DEBUG=off
      - CELERY_BROKER_URL=redis://redis:6379/0
      - DATABASE_URL=postgres://postgres:${POSTGRES_RW_PASSWORD:-POSTGRES_PASSWORD_LOL}@db:5432/postgres
      - REDIS_HOST=localhost
      - REDIS_PORT=8379
    command: nice celery -A infinite_hashes beat -l INFO --schedule /tmp/celerybeat-schedule -f /tmp/logs/celery-beat.log
    volumes:
      - ./logs:/tmp/logs
    depends_on:
      - redis
      - db
    links:
      - redis
    logging:
      <<: *logging

volumes:
  backend-static:
  gunicorn-socket:
  redis:
  db:
